<script>

  document.addEventListener("DOMContentLoaded",function(event) {

    function addToolbar(){
      var toolbar = document.createElement("div");
      toolbar.id = "toolbar";
      toolbar.style.cssText = "position: fixed;top: 0px;left: 0px;width: 100%;padding: 0.5rem;background-color: rgba(255, 255, 255, 0.6);";
      var button = document.createElement("button");
      button.id = "copybutton";
      button.innerText = 'Copy Source Code';
      button.style.cssText = "cursor:pointer;background-color: #aacb65;border: none;font-size: 16px;padding: 8px 20px;color: white;margin-left: auto;display: block;margin-right: 20px;";
      button.addEventListener("click",function(){copyTextToClipboard()});
      toolbar.appendChild(button);
      document.body.appendChild(toolbar);
    }

    function copyTextToClipboard() {
      var button = document.getElementById("copybutton");
      var toolbar = document.getElementById("toolbar");
      var cc1 = document.getElementsByClassName('c-cloudcannon-editor-overlays')[0];
      var cc2 = document.getElementsByClassName('cms-added-content')[0];
      if(cc1)     cc1.remove();
      if(cc2)     cc2.remove();
      if(toolbar)toolbar.remove();

      var allHTML = document.documentElement.outerHTML;
      allHTML = allHTML.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, "");
      if(toolbar) document.body.appendChild(toolbar);
      if(cc2)     document.body.appendChild(cc2);
      if(cc1)     document.body.appendChild(cc1);

      var textArea = document.createElement("textarea");
      textArea.value = allHTML;
      document.body.appendChild(textArea);
      textArea.select();
      try {
        var successful = document.execCommand('copy');
        var msg = successful ? 'successful' : 'unsuccessful';
        console.log('Copying text command was ' + msg);
        if(successful){
          button.innerText = 'Copied!';
          setTimeout(() => {
            button.innerText = 'Copy Source Code';
          }, "3000")
        } else {
          button.innerText = 'Error';
        }
      } catch (err) {
        button.innerText = 'Unable to copy';
      }
      document.body.removeChild(textArea);
    }
    setTimeout(() => {
      if(document.body.classList.contains('cms-editor-active')){
        console.log("We're in the editor. Add the Toolbar!");
        addToolbar();
      }
    }, "1000");
  })



// CLOUDCANNON LIVE EDITING
// https://cloudcannon.com/documentation/articles/using-live-editing-with-vanilla-js///
  if (!window.CloudCannon) {
    document.addEventListener('cloudcannon:load', function (e) {
      onLiveEditorLoad(e.detail.CloudCannon);
    });
  } else {
    onLiveEditorLoad(window.CloudCannon);
  }

  function onLiveEditorLoad(CloudCannon) {
    CloudCannon.enableEvents();
  }

  document.addEventListener('cloudcannon:update', async function (e) {
    useNewPageProps(e.detail.CloudCannon);
  });

  async function useNewPageProps(CloudCannon) {
    const latestValue = await CloudCannon.value();
    console.log("LATEST",latestValue)
    // for (const key in latestValue) {
    //   console.log(key,latestValue[key]);
    //   CloudCannon.set(key, latestValue[key]);
    // }

  }

</script>